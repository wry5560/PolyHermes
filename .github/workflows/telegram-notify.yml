name: Telegram Notification on PR Merge

on:
  pull_request:
    types:
      - closed  # å½“ PR è¢«å…³é—­ï¼ˆåˆå¹¶æˆ–å…³é—­ï¼‰æ—¶è§¦å‘

jobs:
  notify:
    runs-on: ubuntu-latest
    
    # åªåœ¨ PR è¢«åˆå¹¶åˆ° main åˆ†æ”¯æ—¶æ‰§è¡Œ
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get PR details
        id: pr_details
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          
          # è·å– PR è¯¦ç»†ä¿¡æ¯
          PR_RESPONSE=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}")
          
          # è·å– PR å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          FILES_RESPONSE=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}/files")
          
          # æå– PR æè¿°ï¼ˆbodyï¼‰ï¼Œä¿ç•™æ¢è¡Œï¼Œé™åˆ¶é•¿åº¦
          PR_BODY=$(echo "$PR_RESPONSE" | jq -r '.body // ""')
          if [ ${#PR_BODY} -gt 500 ]; then
            PR_BODY="${PR_BODY:0:500}..."
          fi
          
          # ä¿å­˜åˆ°è¾“å‡ºå˜é‡ï¼ˆä½¿ç”¨ base64 ç¼–ç é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
          echo "pr_body<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # æ£€æŸ¥ PR æ˜¯å¦è¢«åˆå¹¶ï¼ˆè€Œä¸æ˜¯ä»…å…³é—­ï¼‰
          PR_MERGED="${{ github.event.pull_request.merged }}"
          if [ "$PR_MERGED" != "true" ]; then
            echo "â„¹ï¸  PR ä»…å…³é—­ï¼Œæœªåˆå¹¶ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
          # æ³¨æ„ï¼šTELEGRAM_CHAT_ID å¯ä»¥æ˜¯ä¸ªäººèŠå¤© IDï¼ˆæ­£æ•°ï¼‰æˆ–ç¾¤ç»„ IDï¼ˆè´Ÿæ•°ï¼Œå¦‚ -1001234567890ï¼‰
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸  Telegram Bot Token æˆ– Chat ID æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          # è·å– PR åŸºæœ¬ä¿¡æ¯
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_MERGE_COMMIT="${{ github.event.pull_request.merge_commit_sha }}"
          
          # è·å– PR è¯¦ç»†ä¿¡æ¯
          PR_BODY="${{ steps.pr_details.outputs.pr_body }}"
          
          # è½¬ä¹‰ PR æ ‡é¢˜ä¸­çš„ HTML ç‰¹æ®Šå­—ç¬¦
          PR_TITLE_ESCAPED=$(echo "$PR_TITLE" | sed 's/&/\&amp;/g' | sed 's/</\&lt;/g' | sed 's/>/\&gt;/g')
          
          # æ„å»ºæ¶ˆæ¯å†…å®¹ï¼ˆä»…åŒ…å«å…³é”®ä¿¡æ¯ï¼‰
          MESSAGE="ğŸš€ <b>main åˆ†æ”¯ä»£ç æ›´æ–°</b>"$'\n'$'\n'"ğŸ“ <b>PR #${PR_NUMBER}:</b> ${PR_TITLE_ESCAPED}"$'\n'"ğŸ”— <a href=\"${PR_URL}\">æŸ¥çœ‹ PR</a>"
          
          # å‘é€ Telegram æ¶ˆæ¯ï¼ˆä½¿ç”¨ jq è½¬ä¹‰ JSONï¼‰
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg chat_id "$TELEGRAM_CHAT_ID" \
              --arg text "$MESSAGE" \
              '{chat_id: $chat_id, text: $text, parse_mode: "HTML", disable_web_page_preview: false}')" > /tmp/telegram_response.json
          
          # æ£€æŸ¥å‘é€ç»“æœ
          if [ $? -eq 0 ]; then
            RESPONSE=$(cat /tmp/telegram_response.json)
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "âœ… Telegram é€šçŸ¥å‘é€æˆåŠŸ"
            else
              echo "âŒ Telegram é€šçŸ¥å‘é€å¤±è´¥: $RESPONSE"
              exit 1
            fi
          else
            echo "âŒ å‘é€ Telegram æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯"
            exit 1
          fi

