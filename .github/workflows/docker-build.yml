name: Build and Push Docker Image

on:
  release:
    types:
      - published  # å½“é€šè¿‡ GitHub Releases é¡µé¢åˆ›å»º release æ—¶è§¦å‘

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}  # ä½¿ç”¨ release å¯¹åº”çš„ tag
      
      - name: Extract version from release
        id: extract_version
        run: |
          # ä» release tag ä¸­æå–ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ v1.0.0 -> 1.0.0ï¼‰
          TAG_NAME="${{ github.event.release.tag_name }}"
          if [ -z "$TAG_NAME" ]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ï¼švæ•°å­—.æ•°å­—.æ•°å­—[-åç¼€]ï¼ˆä¾‹å¦‚ v1.0.0, v2.10.102, v1.0.0-betaï¼‰
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "é”™è¯¯: ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º væ•°å­—.æ•°å­—.æ•°å­— æˆ– væ•°å­—.æ•°å­—.æ•°å­—-åç¼€ (ä¾‹å¦‚: v1.0.0, v1.0.0-beta)"
            exit 1
          fi
          
          VERSION=${TAG_NAME#v}  # ç§»é™¤ v å‰ç¼€
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          echo "Full tag: $TAG_NAME"
      
      - name: Send Telegram notification (build started)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸  Telegram Bot Token æˆ– Chat ID æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          # è·å–æ„å»ºä¿¡æ¯
          VERSION="${{ steps.extract_version.outputs.VERSION }}"
          TAG="${{ steps.extract_version.outputs.TAG }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          
          # æ„å»ºæ¶ˆæ¯å†…å®¹ï¼ˆä»…åŒ…å«å…³é”®ä¿¡æ¯ï¼‰
          MESSAGE="ğŸ”¨ <b>Docker é•œåƒæ„å»ºä¸­</b>"$'\n'$'\n'"ğŸ“¦ <b>ç‰ˆæœ¬:</b> ${VERSION}"$'\n'"ğŸ·ï¸ <b>Tag:</b> <code>${TAG}</code>"$'\n'"ğŸ”— <a href=\"${RELEASE_URL}\">æŸ¥çœ‹ Release</a>"
          
          # å‘é€ Telegram æ¶ˆæ¯ï¼ˆä½¿ç”¨ jq è½¬ä¹‰ JSONï¼‰
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg chat_id "$TELEGRAM_CHAT_ID" \
              --arg text "$MESSAGE" \
              '{chat_id: $chat_id, text: $text, parse_mode: "HTML", disable_web_page_preview: false}')" > /tmp/telegram_response.json
          
          # æ£€æŸ¥å‘é€ç»“æœ
          if [ $? -eq 0 ]; then
            RESPONSE=$(cat /tmp/telegram_response.json)
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "âœ… Telegram é€šçŸ¥å‘é€æˆåŠŸ"
            else
              echo "âŒ Telegram é€šçŸ¥å‘é€å¤±è´¥: $RESPONSE"
              # é€šçŸ¥å¤±è´¥ä¸åº”è¯¥å¯¼è‡´æ•´ä¸ª job å¤±è´¥
              exit 0
            fi
          else
            echo "âŒ å‘é€ Telegram æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯"
            # é€šçŸ¥å¤±è´¥ä¸åº”è¯¥å¯¼è‡´æ•´ä¸ª job å¤±è´¥
            exit 0
          fi
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # å¯ç”¨å¤šæ¶æ„æ„å»ºæ”¯æŒ
          platforms: linux/amd64,linux/arm64
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          # å¤šæ¶æ„æ„å»ºï¼šæ”¯æŒ amd64 å’Œ arm64
          platforms: linux/amd64,linux/arm64
          tags: |
            wrbug/polyhermes:${{ steps.extract_version.outputs.TAG }}
            wrbug/polyhermes:latest
          build-args: |
            VERSION=${{ steps.extract_version.outputs.VERSION }}
            GIT_TAG=${{ steps.extract_version.outputs.TAG }}
            GITHUB_REPO_URL=https://github.com/WrBug/PolyHermes
          cache-from: type=registry,ref=wrbug/polyhermes:latest
          cache-to: type=inline

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸  Telegram Bot Token æˆ– Chat ID æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          # è·å–æ„å»ºä¿¡æ¯
          VERSION="${{ steps.extract_version.outputs.VERSION }}"
          TAG="${{ steps.extract_version.outputs.TAG }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          REPO_NAME="${{ github.repository }}"
          
          # æ„å»ºæ¶ˆæ¯å†…å®¹ï¼ˆä»…åŒ…å«å…³é”®ä¿¡æ¯ï¼‰
          DEPLOY_DOC_URL="https://github.com/WrBug/PolyHermes/blob/main/docs/zh/DEPLOYMENT.md"
          MESSAGE="âœ… <b>Docker é•œåƒæ„å»ºæˆåŠŸ</b>"$'\n'$'\n'"ğŸ“¦ <b>ç‰ˆæœ¬:</b> ${VERSION}"$'\n'"ğŸ·ï¸ <b>Tag:</b> <code>${TAG}</code>"$'\n'"ğŸ”— <a href=\"${RELEASE_URL}\">æŸ¥çœ‹ Release</a>"$'\n'"ğŸ“š <a href=\"${DEPLOY_DOC_URL}\">Docker éƒ¨ç½²æ–‡æ¡£</a>"
          
          # å‘é€ Telegram æ¶ˆæ¯ï¼ˆä½¿ç”¨ jq è½¬ä¹‰ JSONï¼‰
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg chat_id "$TELEGRAM_CHAT_ID" \
              --arg text "$MESSAGE" \
              '{chat_id: $chat_id, text: $text, parse_mode: "HTML", disable_web_page_preview: false}')" > /tmp/telegram_response.json
          
          # æ£€æŸ¥å‘é€ç»“æœ
          if [ $? -eq 0 ]; then
            RESPONSE=$(cat /tmp/telegram_response.json)
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "âœ… Telegram é€šçŸ¥å‘é€æˆåŠŸ"
            else
              echo "âŒ Telegram é€šçŸ¥å‘é€å¤±è´¥: $RESPONSE"
              # æ„å»ºæˆåŠŸï¼Œé€šçŸ¥å¤±è´¥ä¸åº”è¯¥å¯¼è‡´æ•´ä¸ª job å¤±è´¥
              exit 0
            fi
          else
            echo "âŒ å‘é€ Telegram æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯"
            # æ„å»ºæˆåŠŸï¼Œé€šçŸ¥å¤±è´¥ä¸åº”è¯¥å¯¼è‡´æ•´ä¸ª job å¤±è´¥
            exit 0
          fi